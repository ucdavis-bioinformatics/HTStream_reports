---
title: "Preproc mapping stats for UMI testing"
output: html_notebook
---

```{r, echo=FALSE}
### SETTINGS ###
working_dir = "/share/biocore/joshi/projects/LaSalle_J_UCD/2018_LaSalle-Yasui_ChipSeq/test_umi"
preproc_dir = "01-Cleaned"
######################
```

```{r setup, echo=FALSE}
knitr::opts_knit$set(root.dir = working_dir)
```

```{r, echo=FALSE}
library(knitr)
library(kableExtra)
library(jsonlite)
library(readr)
library(stringr)
library(edgeR)

process_json <- function(sdir) { 
    json <- fromJSON(paste0(preproc_dir,"/",sdir,"/",sdir,".stats.log"))
    
    infrag = unlist(lapply(names(json), function(x) json[[x]]$totalFragmentsInput))
    outfrag = unlist(lapply(names(json), function(x) json[[x]]$totalFragmentsOutput))
    
    perc = (outfrag/infrag[1])*100
    perc = sprintf("%.02f%%",perc)
    
    stats = matrix(c(rbind(infrag,outfrag,perc)), nrow=1)
    rownames(stats) = c(sdir)
    
    return(stats)
}
```

```{r, echo=FALSE}
###################
sample_dirs = list.dirs(preproc_dir,full.names = F, recursive = F)

final_stats = t(sapply(sample_dirs, process_json))

json <- fromJSON(paste0(preproc_dir,"/",sample_dirs[1],"/",sample_dirs[1],".stats.log"))
cnames = gsub("_\\d+","",names(json))
cnames = unlist(lapply(cnames, function(x) c(paste(x,"input"), paste(x,"output"), paste(x,"perc"))))

colnames(final_stats) = cnames
###################
```

```{r, echo=FALSE}
numcol = dim(final_stats)[2]
step=6
for (i in seq(1,numcol,step)) {
  if (i+step-1 <= numcol) {
    endcol <- i+step-1
  } else {
    endcol <- numcol
  }
  
  print(kable(final_stats[,i:endcol]) %>% kable_styling(bootstrap_options = c("striped", "hover")))
}
```
